<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Plan de Ejecuci√≥n Comandos NVIH - Completo</title>
    <style>
      *{margin:0;padding:0;box-sizing:border-box}
      body{font-family:Segoe UI,Roboto,Arial,sans-serif;line-height:1.6;color:#333;background:#f5f5f5;padding:20px}
      .container{max-width:1400px;margin:0 auto;background:#fff;padding:30px;border-radius:10px;box-shadow:0 0 20px rgba(0,0,0,.1)}
      h1{color:#2c3e50;text-align:center;margin-bottom:10px;font-size:2.5em;border-bottom:4px solid #3498db;padding-bottom:15px}
      .subtitle{text-align:center;color:#7f8c8d;margin-bottom:30px;font-size:1.05em}
      .fase{margin:30px 0;border-left:5px solid #3498db;padding-left:20px}
      .fase h2{color:#2c3e50;margin-bottom:15px;font-size:1.6em}
      .fase-critica{border-left-color:#e74c3c}.fase-importante{border-left-color:#f39c12}.fase-media{border-left-color:#3498db}.fase-opcional{border-left-color:#95a5a6}
      table{width:100%;border-collapse:collapse;margin:20px 0;background:#fff;box-shadow:0 2px 5px rgba(0,0,0,.06)}
      thead{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
      th{padding:14px;text-align:left;font-weight:600;font-size:.95em;text-transform:uppercase;letter-spacing:.3px}
      td{padding:12px 14px;border-bottom:1px solid #ecf0f1}
      tbody tr:hover{background:#f8f9fa;transition:.2s}
      .badge{display:inline-block;padding:4px 10px;border-radius:20px;font-size:.85em;font-weight:600;min-width:80px;text-align:center}
      .badge-si{background:#27ae60;color:#fff}.badge-no{background:#e74c3c;color:#fff}.badge-cuidado{background:#f39c12;color:#fff}.badge-depende{background:#3498db;color:#fff}.badge-manual{background:#95a5a6;color:#fff}
      .prioridad{font-weight:700;padding:5px 10px;border-radius:5px;display:inline-block}
      .prioridad-critica{background:#ffebee;color:#c62828}.prioridad-alta{background:#fff3e0;color:#e65100}.prioridad-media{background:#e3f2fd;color:#1565c0}.prioridad-baja{background:#f3e5f5;color:#6a1b9a}
      .comando{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#2c3e50;color:#2ecc71;padding:3px 8px;border-radius:4px;font-size:.9em;font-weight:600}
      .resumen{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:22px;border-radius:10px;margin:30px 0}
      .resumen h3{margin-bottom:10px;font-size:1.3em}
      .warning-box{background:#fff3cd;border-left:5px solid #ffc107;padding:16px;margin:20px 0;border-radius:6px}
      .warning-box h4{color:#856404;margin-bottom:8px;font-size:1.05em}
      .script-box{background:#2c3e50;color:#2ecc71;padding:16px;border-radius:8px;margin:20px 0;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:.9em;overflow:auto;max-height:500px}
      .numero-orden{background:#667eea;color:#fff;border-radius:50%;width:32px;height:32px;display:inline-flex;align-items:center;justify-content:center;font-weight:bold;font-size:.85em}
      .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin:20px 0}
      .stat-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:16px;border-radius:10px;text-align:center}
      .stat-card h3{font-size:2.1em;margin-bottom:4px}
      .note{font-size:.9em;color:#64748b}
      @media print{body{background:#fff;padding:0}.container{box-shadow:none;padding:20px}.script-box{max-height:none}}
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üìã Plan de Ejecuci√≥n Comandos NVIH</h1>
      <p class="subtitle">Gu√≠a completa y ordenada para la correcci√≥n de datos del sistema</p>

      <div class="stats">
        <div class="stat-card"><h3>23</h3><p>Comandos Totales</p></div>
        <div class="stat-card"><h3>15</h3><p>Obligatorios</p></div>
        <div class="stat-card"><h3>5</h3><p>Opcionales</p></div>
        <div class="stat-card"><h3>3</h3><p>Solo Manuales</p></div>
      </div>

      <h2 style="color:#2c3e50;margin-top:26px;margin-bottom:10px;">üìä Tabla Completa de Comandos</h2>
      <table>
        <thead>
          <tr>
            <th style="width:6%">#</th>
            <th style="width:22%">Comando</th>
            <th style="width:34%">Funci√≥n</th>
            <th style="width:14%">Alcance</th>
            <th style="width:10%">¬øEjecutar?</th>
            <th style="width:14%">Prioridad / Fase</th>
          </tr>
        </thead>
        <tbody>
          <tr><td><span class="numero-orden">1</span></td><td><span class="comando">fix_fecha_esquema_inicial</span></td><td>Corrige fecha_esquema_tratamiento del primer TAR si es NULL</td><td>Pacientes con TAR</td><td><span class="badge badge-si">‚úì S√ç</span></td><td><span class="prioridad prioridad-critica">Cr√≠tica ¬∑ F1</span></td></tr>
          <tr><td><span class="numero-orden">2</span></td><td><span class="comando">set_establecimiento_inicial</span></td><td>Asigna establecimiento_salud_inicial seg√∫n primer TAR</td><td>Sin EESS inicial</td><td><span class="badge badge-si">‚úì S√ç</span></td><td><span class="prioridad prioridad-critica">Cr√≠tica ¬∑ F1</span></td></tr>
          <tr><td><span class="numero-orden">3</span></td><td><span class="comando">actualiza_condicion_tar</span></td><td>Corrige tipo_condicion (Nuevo/Continuador) en TAR</td><td>Todos los TAR</td><td><span class="badge badge-si">‚úì S√ç</span></td><td><span class="prioridad prioridad-critica">Cr√≠tica ¬∑ F1</span></td></tr>
          <tr><td><span class="numero-orden">4</span></td><td><span class="comando">update_paciente_continuador_si</span></td><td>Sincroniza paciente_continuador seg√∫n primer TAR</td><td>Con TAR</td><td><span class="badge badge-si">‚úì S√ç</span></td><td><span class="prioridad prioridad-critica">Cr√≠tica ¬∑ F1</span></td></tr>
          <tr><td><span class="numero-orden">5</span></td><td><span class="comando">migra_enfermedad_to_tarenfermedad</span></td><td>Migra enfermedades de paciente_enfermedad a TAR</td><td>Enfermedades sin migrar</td><td><span class="badge badge-depende">DEPENDE</span></td><td><span class="prioridad prioridad-media">Media ¬∑ F1</span></td></tr>
          <tr><td><span class="numero-orden">6</span></td><td><span class="comando">actualiza_eess_origen</span></td><td>Actualiza eess_origen desde primer TAR</td><td>Con TAR</td><td><span class="badge badge-si">‚úì S√ç</span></td><td><span class="prioridad prioridad-alta">Alta ¬∑ F2</span></td></tr>
          <tr><td><span class="numero-orden">7</span></td><td><span class="comando">generar_derivaciones_tar</span></td><td>Genera derivaciones por cambios de EESS</td><td>Multi-EESS</td><td><span class="badge badge-si">‚úì S√ç</span></td><td><span class="prioridad prioridad-alta">Alta ¬∑ F3</span></td></tr>
          <tr><td><span class="numero-orden">8</span></td><td><span class="comando">actualiza_derivacion_efectiva</span></td><td>Marca derivaciones como efectivas si hay TAR destino</td><td>Todas</td><td><span class="badge badge-si">‚úì S√ç</span></td><td><span class="prioridad prioridad-alta">Alta ¬∑ F3</span></td></tr>
          <tr><td><span class="numero-orden">9</span></td><td><span class="comando">actualiza_derivacion_essalud</span></td><td>Asume efectivas derivaciones a ESSALUD</td><td>ESSALUD</td><td><span class="badge badge-si">‚úì S√ç</span></td><td><span class="prioridad prioridad-alta">Alta ¬∑ F3</span></td></tr>
          <tr><td><span class="numero-orden">10</span></td><td><span class="comando">actualiza_derivacion_internacional</span></td><td>Marca efectivas derivaciones internacionales</td><td>Internacional</td><td><span class="badge badge-si">‚úì S√ç</span></td><td><span class="prioridad prioridad-alta">Alta ¬∑ F3</span></td></tr>
          <tr><td><span class="numero-orden">11</span></td><td><span class="comando">actualizar_condicion_eess_pacientes</span></td><td>Sincroniza condici√≥n y EESS actual seg√∫n √∫ltimo TAR/derivaci√≥n</td><td>Todos</td><td><span class="badge badge-si">‚úì S√ç</span></td><td><span class="prioridad prioridad-critica">Cr√≠tica ¬∑ F4</span></td></tr>
          <tr><td><span class="numero-orden">12</span></td><td><span class="comando">eliminar_fechas_abandono_en_fallecidos</span></td><td>Elimina fechas de abandono posteriores al fallecimiento</td><td>Fallecidos</td><td><span class="badge badge-si">‚úì S√ç</span></td><td><span class="prioridad prioridad-media">Media ¬∑ F5</span></td></tr>
          <tr><td><span class="numero-orden">13</span></td><td><span class="comando">validate_check_de_fallecido</span></td><td>Pone es_fallecido=False cuando no hay fecha_defuncion (corrige checks marcados por error)</td><td>Pacientes con es_fallecido=True y fecha_defuncion NULL</td><td><span class="badge badge-si">‚úì S√ç</span></td><td><span class="prioridad prioridad-media">Media ¬∑ F5</span></td></tr>
          <tr><td><span class="numero-orden">14</span></td><td><span class="comando">set_paciente_sinadef</span></td><td>Consulta SINADEF y actualiza fallecimientos</td><td>Pacientes (mejor en lotes)</td><td><span class="badge badge-cuidado">‚ö† CUIDADO</span></td><td><span class="prioridad prioridad-media">Media ¬∑ F5</span></td></tr>
          <tr><td><span class="numero-orden">15</span></td><td><span class="comando">automatic_abandonment_patient</span></td><td>Marca abandono por criterios de inactividad</td><td>Sin atenci√≥n reciente</td><td><span class="badge badge-cuidado">‚ö† CUIDADO</span></td><td><span class="prioridad prioridad-media">Media ¬∑ F5</span></td></tr>
          <tr><td><span class="numero-orden">16</span></td><td><span class="comando">registra_cambio_esquema_tratamiento</span></td><td>Historial de cambios de esquema</td><td>Con 2+ TAR</td><td><span class="badge badge-depende">DEPENDE</span></td><td><span class="prioridad prioridad-baja">Baja ¬∑ F6</span></td></tr>
          <tr><td><span class="numero-orden">17</span></td><td><span class="comando">update_tipo_poblacion</span></td><td>Fija tipo_poblacion="General" para menores de 12</td><td>‚â§ 12 a√±os</td><td><span class="badge badge-depende">DEPENDE</span></td><td><span class="prioridad prioridad-baja">Baja ¬∑ F6</span></td></tr>
          <tr><td><span class="numero-orden">18</span></td><td><span class="comando">validar_diagnosticos</span></td><td>Elimina diagn√≥sticos con fecha incorrecta</td><td>Diagn√≥sticos inconsistentes</td><td><span class="badge badge-depende">DEPENDE</span></td><td><span class="prioridad prioridad-baja">Baja ¬∑ F6</span></td></tr>
          <tr><td><span class="numero-orden">19</span></td><td><span class="comando">diagnostico_vih_pacientes</span></td><td>Genera diagn√≥sticos VIH desde servicio externo</td><td>Pacientes sin diagn√≥stico</td><td><span class="badge badge-depende">DEPENDE</span></td><td><span class="prioridad prioridad-baja">Baja ¬∑ F6</span></td></tr>
          <tr><td><span class="numero-orden">20</span></td><td><span class="comando">migrar_enfermedades_a_pacienteenfermedad</span></td><td>Migra enfermedades desde tabla TAR a paciente</td><td>Cuando cambia el modelo</td><td><span class="badge badge-depende">DEPENDE</span></td><td><span class="prioridad prioridad-baja">Baja ¬∑ F6</span></td></tr>
          <tr><td><span class="numero-orden">21</span></td><td><span class="comando">consulta_netlab_pacientes</span></td><td>Actualiza resultados de NetLab</td><td>Por EESS/lotes</td><td><span class="badge badge-depende">DEPENDE</span></td><td><span class="prioridad prioridad-baja">Baja ¬∑ F6</span></td></tr>
          <tr><td><span class="numero-orden">22</span></td><td><span class="comando">migracion_nvih_a_intermediario_vih_tb</span></td><td>Exporta datos a BD intermediaria VIH-TB</td><td>Para reportes TB</td><td><span class="badge badge-depende">DEPENDE</span></td><td><span class="prioridad prioridad-baja">Baja ¬∑ F6</span></td></tr>
          <tr><td><span class="numero-orden">23</span></td><td><span class="comando">actualizar_enfermedad_segun_bd_intermediario</span></td><td>Sincroniza enfermedades desde BD intermediaria</td><td>Enfermedades externas</td><td><span class="badge badge-depende">DEPENDE</span></td><td><span class="prioridad prioridad-baja">Baja ¬∑ F6</span></td></tr>
          <tr><td>-</td><td><span class="comando">cambiar_establecimiento</span></td><td>Migrar pacientes de un EESS a otro (casos puntuales)</td><td>Pacientes espec√≠ficos</td><td><span class="badge badge-manual">MANUAL</span></td><td><span class="prioridad prioridad-baja">Manual</span></td></tr>
          <tr><td>-</td><td><span class="comando">derivaciones_masivas</span></td><td>Crea derivaciones para una lista</td><td>Lista espec√≠fica</td><td><span class="badge badge-manual">MANUAL</span></td><td><span class="prioridad prioridad-baja">Manual</span></td></tr>
          <tr><td>-</td><td><span class="comando">eliminar_paciente</span></td><td>Elimina pacientes por documento</td><td>Pacientes espec√≠ficos</td><td><span class="badge badge-manual">MANUAL</span></td><td><span class="prioridad prioridad-baja">Manual</span></td></tr>
        </tbody>
      </table>

      <div id="fase5" class="fase fase-media">
        <h2>üü£ FASE 5: Condiciones Especiales (Importante)</h2>
        <table>
          <thead><tr><th>Orden</th><th>Comando</th><th>Descripci√≥n</th><th>Comando de Ejecuci√≥n</th></tr></thead>
          <tbody>
            <tr>
              <td><span class="numero-orden">12</span></td>
              <td><span class="comando">eliminar_fechas_abandono_en_fallecidos</span></td>
              <td>Elimina fecha de abandono cuando es posterior a la fecha de fallecimiento.</td>
              <td><code>python manage.py eliminar_fechas_abandono_en_fallecidos</code></td>
            </tr>
            <tr>
              <td><span class="numero-orden">13</span></td>
              <td><span class="comando">validate_check_de_fallecido</span></td>
              <td>
                Establece <code>es_fallecido=False</code> en <code>paciente_paciente</code> cuando <code>fecha_defuncion</code> es NULL. 
                Basado en tu script: hace un <code>bulk_update</code> y loguea en <code>static/validate_check_de_fallecido_log.txt</code>.
              </td>
              <td><code>python manage.py validate_check_de_fallecido</code></td>
            </tr>
            <tr>
              <td><span class="numero-orden">14</span></td>
              <td><span class="comando">set_paciente_sinadef</span></td>
              <td>Consulta SINADEF para actualizar fallecidos. Recomendado en lotes.</td>
              <td>
                <code>python manage.py set_paciente_sinadef --solo_abandono=1 --cantidad=1000</code><br/>
                o<br/>
                <code>python manage.py set_paciente_sinadef --cantidad=1000</code>
              </td>
            </tr>
            <tr>
              <td><span class="numero-orden">15</span></td>
              <td><span class="comando">automatic_abandonment_patient</span></td>
              <td>Marca abandonos autom√°ticos por inactividad (revisar l√≥gica).</td>
              <td><code>python manage.py automatic_abandonment_patient</code></td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="warning-box">
        <h4>‚ö†Ô∏è Advertencias</h4>
        <ul>
          <li>Backup obligatorio de la BD antes de ejecutar.</li>
          <li>Primero en ambiente de prueba o con lotes peque√±os.</li>
          <li>Monitorea archivos de log en la carpeta <code>static/</code>.</li>
        </ul>
      </div>

      <h2 style="color:#2c3e50;margin-top:26px;margin-bottom:10px;">üöÄ Script de Ejecuci√≥n Completo</h2>
      <div class="script-box"><pre>#!/bin/bash
set -e

echo "==== SCRIPT ORDENAMIENTO NVIH ===="
echo "Inicio: $(date)"

# FASE 1
python manage.py fix_fecha_esquema_inicial
python manage.py set_establecimiento_inicial
# Lotes para tipo_condicion
while true; do
  python manage.py actualiza_condicion_tar --cantidad=5000
  read -p "¬øOtro lote de actualiza_condicion_tar? (s/n): " c; [ "$c" = "s" ] || break
done
python manage.py update_paciente_continuador_si
read -p "¬øMigrar enfermedades a TAR? (s/n): " m; [ "$m" = "s" ] && python manage.py migra_enfermedad_to_tarenfermedad

# FASE 2
python manage.py actualiza_eess_origen

# FASE 3
python manage.py generar_derivaciones_tar
python manage.py actualiza_derivacion_efectiva
python manage.py actualiza_derivacion_essalud
python manage.py actualiza_derivacion_internacional

# FASE 4
python manage.py actualizar_condicion_eess_pacientes

# FASE 5
python manage.py eliminar_fechas_abandono_en_fallecidos
python manage.py validate_check_de_fallecido
read -p "¬øEjecutar set_paciente_sinadef en lotes? (s/n): " s
if [ "$s" = "s" ]; then
  while true; do
    python manage.py set_paciente_sinadef --solo_abandono=1 --cantidad=1000
    read -p "¬øOtro lote de SINADEF? (s/n): " c; [ "$c" = "s" ] || break
  done
fi
read -p "¬øMarcar abandonos autom√°ticos? (s/n): " a; [ "$a" = "s" ] && python manage.py automatic_abandonment_patient

echo "Fin: $(date)"
echo "==== COMPLETADO ===="</pre></div>

      <div class="resumen">
        <h3>Resumen de la Fase 5 (limpieza de fallecidos/abandono)</h3>
        <ul>
          <li>1) eliminar_fechas_abandono_en_fallecidos</li>
          <li>2) validate_check_de_fallecido</li>
          <li>3) set_paciente_sinadef (lotes)</li>
          <li>4) automatic_abandonment_patient (si aplica)</li>
        </ul>
      </div>
    </div>
  </body>
</html>
